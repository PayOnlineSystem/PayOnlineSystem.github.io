# Сервис онлайн-фискализации интернет-платежей

Система PayOnline интгерирована со следующими сервисами фискализации:
- АТОЛ
- Orange Data

# История изменений

<table>
  <tr>
   <td>Версия
   </td>
   <td>Дата
   </td>
   <td>Предмет изменения
   </td>
  </tr>
  <tr>
   <td>1.0.9
   </td>
   <td>05.10.2017
   </td>
   <td>
   </td>
  </tr>
  <tr>
   <td>1.0.10
   </td>
   <td>25.06.2019
   </td>
   <td>Добавлены следующие необязательные параметры:
<ul>

<li>ClientName

<li>ClientInn
</li>
</ul>
   </td>
  </tr>
  <tr>
   <td>1.0.11
   </td>
   <td>05.07.2019
   </td>
   <td>Добавлено необязательное поле agentType
   </td>
  </tr>
  <tr>
   <td>1.0.12
   </td>
   <td>16.03.2020
   </td>
   <td>Добавлено необязательное поле nomenclatureCode
   </td>
  </tr>
</table>



# Термины и сокращения


<table>
  <tr>
   <td>Мерчант, ТСП
   </td>
   <td>-
   </td>
   <td>торгово-сервисное предприятие, подключенное к системе.
   </td>
  </tr>
  <tr>
   <td>ККМ
   </td>
   <td>-
   </td>
   <td>контрольно-кассовая машина, предназначенная для механизации кассовых операций, учета денежных поступлений, регистрации приобретения товара и печати кассового чека.
   </td>
  </tr>
  <tr>
   <td>ККТ
   </td>
   <td>-
   </td>
   <td>то же, что ККМ.
   </td>
  </tr>
  <tr>
   <td>Система, PayOnline
   </td>
   <td>-
   </td>
   <td>система приема электронных платежей PayOnline.
   </td>
  </tr>
  <tr>
   <td>Транзакция
   </td>
   <td>-
   </td>
   <td>банковская операция по переводу денег с одного счета на другой.
   </td>
  </tr>
  <tr>
   <td>Фискализация
   </td>
   <td>-
   </td>
   <td>фиксация в фискальной памяти ККТ информации о расчетах с использованием электронных средств платежа.
   </td>
  </tr>
  <tr>
   <td>Фискальный чек, чек
   </td>
   <td>-
   </td>
   <td>документ, формируемый в процессе фискализации, зарегистрированным в налоговой службе расчетным кассовым аппаратом.
   </td>
  </tr>
  <tr>
   <td>ФН, фискальный накопитель
   </td>
   <td>-
   </td>
   <td>устройство, предназначенное для шифрования и защиты фискальных данных.
   </td>
  </tr>
  <tr>
   <td>ФНС
   </td>
   <td>-
   </td>
   <td>Федеральная Налоговая Служба
   </td>
  </tr>
</table>


# Общие сведения

Сервис обеспечивает формирование электронного фискального чека при покупке товаров или оплате услуг, совершенных с использованием электронных средств платежа.

Наряду с электронным платежами, совершенными через систему PayOnline, сервис позволяет фискализировать и платежи, совершенные вне Системы.

Передача данных чека мерчанту — Система автоматически направляет данные чека в ответе мерчанту. 


# Авторизация

Параметр SecurityKey вычисляется хэш-функцией md5 от тела запроса, дополненного секретным ключом ТСП и идентификатором сайта.

Хэш вычисляется от строки: 


```
RequestBody=$"{RequestBody}&MerchantId={MerchantId}&PrivateSecurityKey={PrivateSecurityKey}"
```


где PrivateSecurityKey — секретный ключ ТСП. Найти его можно в разделе «Интеграция» личного кабинета.

Порядок следования параметров и регистр символов важен. 

Вместо выражений в фигурных скобках подставляются значения параметров.

Параметр MerchantId и SecurityKey должны передаваться в строке HTTP-запроса.

(т.е. методом GET)



Пример запроса:


```
https://secure.payonlinesystem.com/Services/Fiscal/Request.ashx?MerchantId=82152&SecurityKey=0b0c4e0bdf6a3ef98276afbb5501dfd3
```


Для следующих параметров:


```
{
  "operation": "Benefit",
  "transactionId": "62321451",
  "paymentSystemType": "Card",
  "totalAmount": 1000.11,
  "goods":[
    {
      "description": "Комплект из 2 пар носков",
      "quantity": 1,
      "amount": 799.09,
      "tax": "vat18"
    },
    {
      "description": "Футболка",
      "quantity": 1,
      "amount": 201.02,
      "tax": "vat18"
    }
  ],
  "email": user011@domen.ru
}
```


MerchantId = 82152, 

PrivateSecurityKey = 3844908d-4c2a-42e1-9be0-91bb5d068d22

Хэш вычисляется от строки:


```
Md5("RequestBody={"operation":"Benefit","transactionId":"62321451","paymentSystemType":"Card","totalAmount":1000.11,"goods":[{"description":"Комплект из 2 пар носков","quantity":1,"amount":799.09,"tax":"vat18"},{"description":"Футболка","quantity":1,"amount":201.02,"tax":"vat18"}],"email":"user011@domen.ru"}&MerchantId=82152&PrivateSecurityKey=3844908d-4c2a-42e1-9be0-91bb5d068d22")
```


и будет равен: 0b0c4e0bdf6a3ef98276afbb5501dfd3


# Типы чеков

Системой могут формировать следующие типы чеков:



*   Чек с признаком расчета «Приход» - при проведении операции оплаты.
*   Чек с признаком расчета «Возврат» — при проведении операции отмены или возврата платежа


# Формат передачи данных

Данные для формирования чека должны передаваться методом POST на адрес [https://secure.payonlinesystem.com/Services/Fiscal/Request.ashx?MerchantId={MerchantId}&SecurityKey={SecurityKey](https://secure.payonlinesystem.com/Services/Fiscal/Request.ashx?MerchantId={MerchantId}&SecurityKey={SecurityKey)}

Тело запроса должно содержать документ в формате JSON, соответствующий схеме из примеров ниже. 

Если поле содержит null, оно не включается в посылаемый JSON.

Запрос обязательно должен содержать HTTP-заголовок:


```
Content-Type: application/json
```





# Входные данные


<table>
  <tr>
   <td><strong>Название</strong>
   </td>
   <td><strong>Формат данных</strong>
   </td>
   <td><strong>Описание</strong>
   </td>
  </tr>
  <tr>
   <td>operation
   </td>
   <td>enum
   </td>
   <td>Тип операции (чека).
<ul>

<li>Возможные значения:

<li>“Benefit” — приход (оплата);

<li>“Charge” — возврат.


</li>
</ul>
Обязательный параметр.
   </td>
  </tr>
  <tr>
   <td>transactionId
   </td>
   <td>string
   </td>
   <td>Идентификатор транзакции.
<p>
Обязательный параметр
   </td>
  </tr>
  <tr>
   <td>paymentSystemType
   </td>
   <td>enum
   </td>
   <td>Тип платежной системы.
<p>
Возможные значения:
<ul>

<li>“card” — банковская карта;

<li>“wm” — WebMoney;

<li>“yd” — Yandex.Деньги;

<li>“qiwi” — QIWI;

<li>“custom” — другое.


</li>
</ul>
Обязательный параметр.
   </td>
  </tr>
  <tr>
   <td>typeOfPayment
   </td>
   <td>int
   </td>
   <td>Тип платежа.
<p>
Возможные значения:
<ul>

<li>"1" — Сумма по чеку наличными,

<li>"2" — Сумма по чеку электронными,

<li>"14" — Сумма по чеку предоплатой,

<li>"15" — Сумма по чеку постоплатой (в кредит),

<li>"16" — Сумма по чеку (БСО) встречным предоставлением.

</li>
</ul>
По умолчанию — "2" (сумма по чеку электронными).
Опциональный параметр.
   </td>
  </tr>
  <tr>
   <td>totalAmount
   </td>
   <td>decimal
   </td>
   <td>Итоговая сумма чека в рублях с округлением:
<ul>

<li>целая часть — не более 8 знаков;

<li>дробная часть — не более 2 знаков.


</li>
</ul>
Обязательный параметр
   </td>
  </tr>
  <tr>
   <td>goods
   </td>
   <td>массив 
   </td>
   <td>Перечисление характеристик товаров, включаемых в чек
   </td>
  </tr>
  <tr>
   <td>email
   </td>
   <td>string
   </td>
   <td>Email плательщика. 
<p>
Опциональный параметр.
<p>
Если параметр “typeOfProcessing” не указан, то “email” можно не передавать.
<p>
(берется из транзакции)
   </td>
  </tr>
  <tr>
   <td>typeOfProcessing
   </td>
   <td>string
   </td>
   <td>Название процессинга.
<p>
Опциональный параметр.
<p>
(См. примечание)
   </td>
  </tr>
  <tr>
   <td>clientName
   </td>
   <td>string
   </td>
   <td>Наименование клиента или фамилия, имя, отчество (при наличии), серия и номер паспорта покупателя (клиента)
<p>
Максимальная длина строки – 256 символов.
<p>
Опциональный параметр.
   </td>
  </tr>
  <tr>
   <td>clientInn
   </td>
   <td>string
   </td>
   <td>ИНН организации или покупателя (клиента)
<p>
Допустимое количество символов 10 или 12, только цифры.
<p>
Опциональный параметр.
   </td>
  </tr>
  <tr>
   <td>agentType
   </td>
   <td>string
   </td>
   <td>Признак агента по предмету расчёта (ограничен агентами, введенными в ККТ при фискализации).
<p>
Возможные значения:
<ul>

<li>«bank_paying_agent» – банковский платежный агент. Оказание услуг покупателю (клиенту) пользователем, являющимся банковским платежным агентом.</li>


<li>«bank_paying_subagent» – банковский платежный субагент. Оказание услуг покупателю (клиенту) пользователем, являющимся банковским платежным субагентом.</li>


<li>«paying_agent» – платежный агент. Оказание услуг покупателю (клиенту) пользователем, являющимся платежным агентом.</li>

<li>«paying_subagent» – платежный субагент. Оказание услуг покупателю (клиенту) пользователем, являющимся платежным субагентом.</li>


<li>«attorney» – поверенный. Осуществление расчета с покупателем (клиентом) пользователем, являющимся поверенным.</li>

<li>«commission_agent» – комиссионер. Осуществление расчета с покупателем (клиентом) пользователем, являющимся комиссионером.</li>

<li>«another» – другой тип агента. Осуществление<strong> </strong>расчета с покупателем (клиентом) пользователем, являющимся агентом и не являющимся банковским платежным агентом (субагентом), платежным агентом (субагентом), поверенным, комиссионером. </li>



</ul>
Опциональный параметр.
   </td>
  </tr>
</table>


Структура товара, включенного в чек


<table>
  <tr>
   <td><strong>Название</strong>
   </td>
   <td><strong>Формат данных</strong>
   </td>
   <td><strong>Описание</strong>
   </td>
  </tr>
  <tr>
   <td>description
   </td>
   <td>string
   </td>
   <td>Наименование товара. Максимальная длина строки — 128 символов.
<p>
Обязательный параметр.
   </td>
  </tr>
  <tr>
   <td>quantity
   </td>
   <td>double
   </td>
   <td>Количество/вес:
<ul>

<li>целая часть — не более 8 знаков;

<li>дробная часть — не более 3 знаков.


</li>
</ul>
Обязательный параметр
   </td>
  </tr>
  <tr>
   <td>amount
   </td>
   <td>decimal
   </td>
   <td>Цена в рублях: 
<ul>

<li>целая часть — не более 8 знаков;

<li>дробная часть — не более 2 знаков.


</li>
</ul>
Обязательный параметр.
   </td>
  </tr>
  <tr>
   <td>tax
   </td>
   <td>enum
   </td>
   <td>Устанавливает номер налога в ККТ.
<p>
Возможные значения:
<ul>

<li>«none» — без НДС;

<li>«vat0» — НДС по ставке 0%;

<li>«vat10» — НДС по ставке 10%;

<li>«vat18» — НДС по ставке 18%;

<li>«vat20» — НДС по ставке 20%;

<li>«vat110» — НДС по ставке 10/110;

<li>«vat118» — НДС по ставке 18/118;

<li>«vat120» — НДС по ставке 20/120.


</li>
</ul>
Обязательный параметр.
   </td>
  </tr>
  <tr>
   <td>paymentMethodType
   </td>
   <td>int
   </td>
   <td>Признак способа расчета.
<p>
Возможные значения:
<ul>

<li>"1" — предоплата 100%;

<li>"2" — частичная предоплата);

<li>"3" — аванс;

<li>"4" — полный расчет;

<li>"5" — частичный расчет и кредит;

<li>"6" — передача в кредит;

<li>"7" — оплата кредита.

</li>
</ul>
По умолчанию — "4" (полный расчёт).
Опциональный параметр.
   </td>
  </tr>
  <tr>
   <td>paymentSubjectType
   </td>
   <td>int
   </td>
   <td>Признак предмета расчета.
<p>
Возможные значения:
<ul>

<li>"1" — товар;

<li>"2" — подакцизный товар;

<li>"3" — работа;

<li>"4" — услуга;

<li>"5" — ставка азартной игры;

<li>"6" — выигрыш азартной игры;

<li>"7" — лотерейный билет;

<li>"8" — выигрыш лотереи;

<li>"9" — предоставление РИД;

<li>"10" — платеж;

<li>"11" — агентское вознаграждение;

<li>"12" — составной предмет расчета;

<li>"13" — иной предмет расчета.

</li>
</ul>
По умолчанию — "1" (товар).
Опциональный параметр.
   </td>
  </tr>


   <tr>
   <td>nomenclatureCode
   </td>
   <td>string
   </td>
   <td>Код товарной номенклатуры.
<p>
Строка, содержащая base64 кодированный массив от 8 до 32 байт либо null

Опциональный параметр.
</li>
</ul>
   </td>
  </tr>
</table>


Примечания



*   Передача параметров должна выполняться с использованием TLS не ниже 1.1.
*   Параметр typeOfProcessing необходимо передавать в случае, если платеж был осуществлен не по карте или обрабатывался не системой PayOnline.
*   Сумма товаров в массиве goods должна совпадать с итоговой суммой чека totalAmount

Пример входных данных для операций «Приход»:


```
{  
  "operation": "Benefit",
  "transactionId": "62321451",
  "paymentSystemType": "Card",
  "typeOfPayment": 14,
  "totalAmount": 1000.11,
  "goods":[  
    {  
      "description": "Комплект из 2 пар носков",
      "quantity": 1,
      "amount": 799.09,
      "tax": "vat18",
      "paymentMethodType": 1,
      "paymentSubjectType": 2

    },
    {  
      "description": "Футболка",
      "quantity": 1,
      "amount": 201.02,
      "tax": "vat18",
      "paymentSubjectType": 3
    }
  ],
  "email": "user011@domen.ru",
  "typeOfProcessing": "PayPal"
}
```




Пример входных данных для операция “Возврат”


```
{  
  "operation": "Charge",
  "transactionId": "12321451",
  "paymentSystemType": "Card",
  "typeOfPayment": 14,
  "totalAmount": 799.09,
  "goods":[  
    {  
      "description": "Комплект из 2 пар носков",
      "quantity": 1,
      "amount": 799.09,
      "tax": "vat18"
      "paymentMethodType": 1,
      "paymentSubjectType": 2
    }
  ],
  "email": "user011@domen.ru",
  "typeOfProcessing": "Payonline"
}
```

# Данные на выходе

Структура ответа:


<table>
  <tr>
   <td><strong>Название</strong>
   </td>
   <td><strong>Описание</strong>
   </td>
  </tr>
  <tr>
   <td>status
   </td>
   <td>Статус
   </td>
  </tr>
  <tr>
   <td>payload
   </td>
   <td>Реквизиты фискализации документа.
<p>
(если включена отправка данных)
   </td>
  </tr>
</table>


Структура Status:


<table>
  <tr>
   <td><strong>Название</strong>
   </td>
   <td><strong>Формат</strong>
   </td>
   <td><strong>Описание</strong>
   </td>
  </tr>
  <tr>
   <td>code
   </td>
   <td>int
   </td>
   <td>Код статуса
   </td>
  </tr>
  <tr>
   <td>text
   </td>
   <td>string
   </td>
   <td>Текст статуса (кодировка utf–8)
   </td>
  </tr>
</table>


Структура Payload:


<table>
  <tr>
   <td><strong>Название</strong>
   </td>
   <td><strong>Формат</strong>
   </td>
   <td><strong>Описание</strong>
   </td>
  </tr>
  <tr>
   <td>name_document
   </td>
   <td>string
   </td>
   <td>Наименование документа
   </td>
  </tr>
  <tr>
   <td>recipient
   </td>
   <td>string
   </td>
   <td>Получатель
   </td>
  </tr>
  <tr>
   <td>fiscal_receipt_number
   </td>
   <td>int
   </td>
   <td>Номер чека в смене
   </td>
  </tr>
  <tr>
   <td>shift_number
   </td>
   <td>int
   </td>
   <td>Номер смены
   </td>
  </tr>
  <tr>
   <td>receipt_datetime
   </td>
   <td>string
   </td>
   <td>Дата и время документа из ФН
   </td>
  </tr>
  <tr>
   <td>address
   </td>
   <td>string
   </td>
   <td>URL сайта
   </td>
  </tr>
  <tr>
   <td>organization
   </td>
   <td>string
   </td>
   <td>Наименование организации
   </td>
  </tr>
  <tr>
   <td>inn
   </td>
   <td>string
   </td>
   <td>ИНН
   </td>
  </tr>
  <tr>
   <td>tax_system
   </td>
   <td>enum
   </td>
   <td>Система налогообложения (СН).
<p>
Возможные значения:
<ul>

<li>«osn» — общая СН;

<li>«usn_income» — упрощенная СН (доходы);

<li>«usn_income_outcome» — упрощенная СН (доходы минус расходы);

<li>«envd» — единый налог на вмененный доход;

<li>«esn» — единый сельскохоз налог;

<li>«patent» — патентная СН.
</li>
</ul>
   </td>
  </tr>
  <tr>
   <td>operation
   </td>
   <td>enum
   </td>
   <td>Тип операции (чека). Возможные значения:
<ul>

<li>“Benefit” — приход (оплата);

<li>“Charge” — возврат
</li>
</ul>
   </td>
  </tr>
  <tr>
   <td>description
   </td>
   <td>string
   </td>
   <td>Наименование товара
   </td>
  </tr>
  <tr>
   <td>total
   </td>
   <td>decimal
   </td>
   <td>Итоговая сумма чека в рублях с округлением:
<ul>

<li>целая часть не более 8 знаков;

<li>дробная часть не более 2 знаков.

<p>
При регистрации в ККТ происходит расчёт фактической суммы: суммирование значений amountпозиций. 
<p>
Допустимое значение 
<p>
totalAmount — в диапазоне от целой части фактической суммы до точного значения фактической суммы.
</li>
</ul>
   </td>
  </tr>
  <tr>
   <td>form_payment
   </td>
   <td>enum
   </td>
   <td>Форма расчёта.
<p>
Возможные значения:
<ul>

<li>“card” — банковская карта;

<li>“wm” — WebMoney;

<li>“yd” — Yandex.Деньги;

<li>“qiwi” — QIWI;

<li>“custom” — другое.
</li>
</ul>
   </td>
  </tr>
  <tr>
   <td>employee_name
   </td>
   <td>string
   </td>
   <td>Имя ответственного сотрудника
   </td>
  </tr>
  <tr>
   <td>employee_position
   </td>
   <td>string
   </td>
   <td>Должность ответственного сотрудника
   </td>
  </tr>
  <tr>
   <td>fn_number
   </td>
   <td>string
   </td>
   <td>Заводской номер экземпляра модели ФН
   </td>
  </tr>
  <tr>
   <td>ecr_registration_number
   </td>
   <td>string
   </td>
   <td>Регистрационный номер ККТ
   </td>
  </tr>
  <tr>
   <td>fiscal_document_number
   </td>
   <td>int
   </td>
   <td>Фискальный номер документа
   </td>
  </tr>
  <tr>
   <td>fiscal_document_attribute
   </td>
   <td>string
   </td>
   <td>Фискальный признак документа
   </td>
  </tr>
  <tr>
   <td>fns_site
   </td>
   <td>string
   </td>
   <td>Адрес сайта ФНС
   </td>
  </tr>
  <tr>
   <td>email
   </td>
   <td>string
   </td>
   <td>Email магазина
   </td>
  </tr>
  <tr>
   <td>tax_amount
   </td>
   <td>decimal
   </td>
   <td>Сумма налога в рублях:
<ul>

<li>целая часть не более 8 знаков;

<li>дробная часть не более 2 знаков.
</li>
</ul>
   </td>
  </tr>
</table>


Пример ответа при успешной фискализации и включенной передаче данных чека мерчанту (payload):


```
{  
  "status": { 
    "code": -1,
    "text": "Документ успешно фискализирован"
  },
  "payload": {  
    "name_document": "2ea26f17-0884-4f08-b120-306fc096a58f",
    "recipient": "user011@domen.ru",
    "total": 799.09,
    "form_payment": "Card",
    "employee_name": "Иванов Иван",
    "employee_position": "Финансовый директор",
    "fns_site": "www.nalog.ru",
    "email": "www.nalog.ru",
    "fn_number": "1110000100238211",
    "shift_number": 23,
    "receipt_datetime": "12.04.2017 20:16:00",
    "address": "www.fortcomltd.ru",
    "organization": "ООО Сити Сервис",
    "inn": "7714698320",
    "tax_system": "osn",
    "operation": "Benefit",
    "description": "Футболка",
    "fiscal_receipt_number": 6,
    "fiscal_document_number": 133,
    "ecr_registration_number": "0000111118041361",
    "fiscal_document_attribute": "3449555941",
    "tax_amount": 143.83
  }
}
```


Пример ответа при отключенной передаче параметров чека:


```
{  
  "status": {  
    "code": -1,
    "text": "Документ успешно фискализирован"
  },
  "payload": null,
  }
}
```


Пример ответа с ошибкой:


```
{  
  "status": {  
    "code": 2,
    "text": "Некорректный запрос"
  },
  "payload": null,
}
```





# Коды ошибок


<table>
  <tr>
   <td>Код
   </td>
   <td>Значение
   </td>
  </tr>
  <tr>
   <td>-1
   </td>
   <td>Документ успешно фискализирован
   </td>
  </tr>
  <tr>
   <td>7
   </td>
   <td>Сообщение не было помещено в очередь за отведенное время
   </td>
  </tr>
  <tr>
   <td>8
   </td>
   <td>Ошибка валидации входящего чека с GUID \"{0}\": {1}
   </td>
  </tr>
  <tr>
   <td>9
   </td>
   <td>Ошибка отправки в очередь входящего чека с GUID \"{0}\": {1}
   </td>
  </tr>
  <tr>
   <td>11
   </td>
   <td>Не распознан tokenId запроса
   </td>
  </tr>
  <tr>
   <td>12
   </td>
   <td>Переданный токен не найден в БД
   </td>
  </tr>
  <tr>
   <td>13
   </td>
   <td>Переданный токен не активен
   </td>
  </tr>
  <tr>
   <td>15
   </td>
   <td>Не распознан uuid запроса
   </td>
  </tr>
  <tr>
   <td>16
   </td>
   <td>Нет информации, попробуйте позднее
   </td>
  </tr>
  <tr>
   <td>21
   </td>
   <td>Ошибка разбора сообщения
   </td>
  </tr>
  <tr>
   <td>22
   </td>
   <td>Таймаут при совершении фискализации
   </td>
  </tr>
  <tr>
   <td>23
   </td>
   <td>Мерчант не найден или не настроен
   </td>
  </tr>
  <tr>
   <td>28
   </td>
   <td>Чек с данным идентификатором уже был создан в системе
   </td>
  </tr>
</table>



<!-- Docs to Markdown version 1.0β19 -->
